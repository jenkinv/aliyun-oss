#!/usr/bin/env node
/**
 * Aliyun command prompt
 * @params - cmd
 */

var fs = require('fs'),
    util = require('util'),
    colors = require('colors'),
    datetime = require('datetime');

var ossAPI = require('../client');

var options = {
  accessId: '',
  accessKey: ''
};

var argv = require('optimist')
      .alias('l', 'list')
      .argv;


var currentPath = fs.realpathSync('.');

var KEY_PATH = './options.json';
//load option
try {
  options = JSON.parse(fs.readFileSync(KEY_PATH));
} catch(e){}


var oss = new ossAPI.OssClient(options);

var appLauncher = {
  command: argv._[0] ? argv._[0] : 'help',
  list: argv.list
};

runLauncher(appLauncher);

function runLauncher(appLauncher) {
  if(appLauncher.command != 'login' && (!options || !options.accessId || !options.accessKey)) {
    console.log('please login first!.use [aliyun-oss login accessId accessKey]'.red);
    return;
  }
  //console.log('current path is [' + currentPath + ']');
  switch(appLauncher.command) {
    case 'login':
      doLogin(argv._[1], argv._[2]);
      break;
    case 'ls':
      doListBuckets(appLauncher.list, argv._[1]);break;
      break;
    case 'cp':
      doCopy(argv._[1], argv._[2]);
      break;
    case 'help':
    default:
      console.log('output help info.');
  }
}

function doLogin(accessId, accessKey) {
  var options = {accessId: accessId, accessKey: accessKey};
  fs.writeFileSync(KEY_PATH, JSON.stringify(options));
}

function doListBuckets(isList, path) {
  if(!path) { //list buckets
    oss.listBucket(function(err, list) {
      if(err) {
        console.log(err);return;
      }
      var buckets = list['Buckets']['Bucket'];
      buckets.forEach(function(bucket) {
        if(isList) {
          var date = datetime.format(new Date(bucket.CreationDate), '%Y/%m/%d %H:%M:%S');
          console.log(date + '    ' + bucket.Name.blue.bold);
        } else {
          console.log(bucket.Name.blue.bold);
        }
      });
    });
  } else {//list files in one bucket
    var path = normalizePath(path);
    if(!path || !path.bucket) {
      console.log('bucket is not set!'.red); return;
    } else {
      oss.listObject(path.bucket, path.path, null, '/', 100, function(err, result) {
        if(err) {
          console.log(err.red); return;
        } else {
          //console.log(result);
          var objects = result['Contents'] || [],
              groups  = result['CommonPrefixes'] || [];
          if(!util.isArray(objects)) {
            objects = [objects];
          }
          if(!util.isArray(groups)) {
            groups = [groups];
          }
          for(var i=0, l=groups.length; i < l; i++) {
            var group = groups[i]['Prefix'];
            console.log(group.substring(path.path.length, group.length - 1).blue.bold);
          }
          for(var i=0, l=objects.length; i < l; i++) {
            var objectKey = objects[i]['Key'];
            var modifyDate = datetime.format(new Date(objects[i]['LastModified']), '%Y/%m/%d %H:%M:%S');
            console.log((isList? modifyDate + '    ' :'') + objectKey.substring(path.path.length));
          }
        }
        
      });
    }
  }
  
}

/**
 * COPY file between oss and local filesystem.
 *
 * src - local file path [/home/oss/text.txt] or
 *         oss file path [oss:test/text.txt] 
 * target - just as src
 */
function doCopy(src, target) {
  src = normalizePath(src);
  target = normalizePath(target);
  if(!src || !target) {
    console.log('you should input `cp src target`, oss path start with bucketname:'.red);
    return;
  }
  if(!target.filename) {//not set target filename, copy from src filename.
    target.filename = src.filename;
    target.path += src.filename;
  }

  var isSrcOss = !!src.bucket,
      isTargetOss = !!target.bucket;


  if(!isSrcOss && !isTargetOss) {
    console.log('no oss path found!'.red);
    return;
  }

  if(isSrcOss && isTargetOss) {//copy object innner oss
    if(!src.bucket || src.bucket != target.bucket) {
      console.log('CANN\'T copy file between different bucket!'.red);return;
    }
    oss.copyObject(src.bucket, target.path, src.path, function(err) {
      if(err) {
        console.log(err);
      } else {
        console.log('copy file succ.'.green);
      }
    });
  }

  if(isSrcOss && !isTargetOss) {//download file from oss
    oss.getObject(src.bucket, src.path, target.path, function(err){
      if(err) {
        console.log(err);
      } else {
        console.log('download file succ.'.green);
      }
    });
    return;
  }

  if(!isSrcOss && isTargetOss) {//upload file to oss
    oss.putObject(target.bucket, target.path, src.path, function(err) {
      if(err) {
        console.log(err);
      } else {
        console.log('upload file succ.'.green);
      }
    });
    return;
  }
}

/**
 * normalize the path. 
 * oss path sample is 'buckname:test/hello.txt'
 * local path sample is '/home/jen/world.txt'
 * return {bucket: path: filename: origin}
 */
function normalizePath(filepath) {
  if(!filepath) return null;
  var regexp = /^(?:([a-z0-9_\-]{1,16}):)?(.*)$/i,
      expResult = filepath.match(regexp),
      bucket = expResult[1],
      path = expResult[2]||'',
      filename = path.split('/').pop();
  if(!!bucket) {//change bucketname:/test/hello.txt to bucketname:text/hello.txt
    path = path.replace(/^\/+/, '');
  }
  if(!bucket && !path) {
    console.log((filepath + ' is not valid path.').red);
    return null;
  } else {
    return {bucket: bucket, path: path, filename: filename, origin: filepath};
  }
  
}
